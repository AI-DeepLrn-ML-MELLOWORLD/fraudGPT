<html>

<head>
    <title>Fraud GPT</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.3/jquery.min.js"
        integrity="sha512-STof4xm1wgkfm7heWqFJVn58Hm3EtS31XFaagaa8VMReCXAkQnJZ+jEy8PCC/iT18dFy95WcExNHFTqLyp72eQ=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.5.0/semantic.min.js"
        integrity="sha512-Xo0Jh8MsOn72LGV8kU5LsclG7SUzJsWGhXbWcYs2MAmChkQzwiW/yTQwdJ8w6UA9C6EVG18GHb/TrYpYCjyAQw=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-serialize-object/2.5.0/jquery.serialize-object.min.js"
        integrity="sha512-Gn0tSSjkIGAkaZQWjx3Ctl/0dVJuTmjW/f9QyB302kFjU4uTNP4HtA32U2qXs/TRlEsK5CoEqMEMs7LnzLOBsA=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.5.0/semantic.min.css"
        integrity="sha512-KXol4x3sVoO+8ZsWPFI/r5KBVB/ssCGB5tsv2nVOKwLg33wTFP3fmnXa47FdSVIshVTgsYk/1734xSk9aFIa4A=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style type="text/css">
        body {
            background-color: #DADADA;
        } 

        body>.grid {
            height: 100%;
        }

        .image {
            margin-top: -100px;
        }

        .column {
            max-width: 450px;
        }

        .hidden {
            visibility: collapse;
            display: none !important;
        }
        .score {
            font-size: 8em !important;
        }
        .vault_image {
            width: 20em;
        }
        .column {
            max-width: unset !important;
            margin-left: 10em;
            margin-right: 10em;
        }
        .vault_description {
            font-size: xx-small;
        }
        .prop {
            margin-top: 10px !important;
            margin-left: 10px !important;
            margin-right: 10px !important;
        }
    </style>
</head>

<body>
    <div class="ui middle aligned center aligned grid initial">
        
        <div class="column">
            <h2 class="ui image header">
                <img src="/logo-sm.png" class="image">
                <div class="content">
                    Enter Marketplace URL
                </div>
            </h2>
            <form class="ui large form">
                <div class="ui stacked segment">
                    <div class="field">
                        <div class="ui left icon input">
                            <i class="cart arrow down icon"></i>
                            <input class="tokenId" type="hidden" name="tokenId" >
                            <input class="url" type="text" name="url" placeholder="url...">
                            
                        </div>
                    </div>
                    <div class="ui fluid large submit button">Get Fraud Score</div>
                </div>

                <div class="ui error message"></div>

            </form>
            <div class="ui message">
                New to Emblem Vault? <a href="https://emblem.finance">Visit us today</a> | <a class="ordinals button">View Recents</a>
            </div>
        </div>
    </div>
    <div class="ui middle aligned center aligned grid hidden display" >
        <div class="column">
            <div class="ui fluid large submit button back">Investigate another listing</div>
            <div class="ui raised very padded text container segment ">
                <p class="ui header score"></p>
                <div class="field">
                    <div class="ui left icon input">
                        <i class="lock icon"></i>
                        <input class="password" type="password" name="password" placeholder="*********">
                        <div class="ui fluid large flag button">Flag as fraud</div>
                    </div>
                </div>
                <p><img class="ui medium rounded vault_image" src=""></p>
                <p class="vault_name"></p>
                <p class="vault_description"></p>
                <h3>Vault address</h3>
                <p class="vault_address"></p>
                <h3>Ordinal Owner</h3>
                <p class="ordinal_owner"></p>
                <h3>What's described as in the vault</h3>
                <p class="properties"></p>
                <h3>What's actually in the vault</h3>
                <p class="balances"></p>     
                <h3>Risk Score Reasons</h3>
                <p class="reasons"></p>
                <p class="links"></p>
            </div>
            <div class="ui message">
                New to Emblem Vault? <a href="https://emblem.finance">Visit us today</a> | <a class="ordinals button">View Recents</a>
            </div>
        </div>
    </div>
    <div class="ui modal">
        <div class="header modal_header">Recent Ordinal Vaults</div>
        <div class="scrolling content modal_content">
          <p>Loading...</p>
        </div>
      </div>
    <script>
        $(document).ready(()=>{
            let url = getParameterByName("url")
            let start = getParameterByName("start") || 0
            getVaults(start)
            if (url){
                $(".url").val(url)
                $("form .submit.button").trigger('click')
            }
        })
        $(".ordinals").click(()=>{
            $('.ui.modal')
            .modal('show')
        })
        $('.back').click(()=>{
            $(".initial").addClass('visible')
            $(".initial").removeClass('hidden')
            $(".display").removeClass('visible')
            $(".display").addClass('hidden')            
        })       

        $('.flag.button').api({
            url: '/v1/fraud/',
            serializeForm: true,
            beforeSend: function(settings) {
                let pass = $(".password").val()
                localStorage.setItem("fraudPassword", pass)
                settings.headers = {
                    "password": pass,
                    "tokenid": $(".tokenId").val()
                }
                return settings;
            },
            onComplete: function(response) {
                console.log(response);
            },
            onSuccess: function(response) {
                if (JSON.parse(response).success) {
                    $('.flag.button').addClass("disabled")
                    $('.flag.button').text("flagged")
                } else {
                    $('.flag.button').text("error")
                    setTimeout(()=>{$('.flag.button').text("Flag as fraud")},2000)
                }
                
            },
            onError: function(error) {
                $('.flag.button').text("error")
                setTimeout(()=>{$('.flag.button').text("Flag as fraud")},2000)
            }
        })

        $('form .submit.button')
            .api({
                url: '/v1/meta/',
                serializeForm: true,
                beforeSend: function (settings) {
                    $(".error").addClass('hidden')
                    settings.urlData = { url: settings.data.url }
                    return settings;
                },
                onResponse: function (response) {
                    $(".display").removeClass('hidden')
                    $(".initial").addClass('hidden')
                    return response;
                },onSuccess: function(response) {
                    response.metadata.fraud? ()=>{
                        $(".flag").addClass("disabled");
                        $(".flag").text("Already Flagged")
                    }: {}
                    $(".links").append(`view this vault on [<a href="https://opensea.io/assets/ethereum/0x82c7a8f707110f5fbb16184a5933e9f78a34c6ab/${response.metadata.tokenId}">opensea</a> | <a href="https://looksrare.org/collections/0x82C7a8f707110f5FBb16184A5933E9F78a34c6ab/${response.metadata.tokenId}">looksrare</a> | <a href="https://emblem.finance/nft?id=${response.metadata.tokenId}">emblelm vault</a>]`)
                    $(".password").val(localStorage.getItem("fraudPassword"))
                    $(".tokenId").val(response.metadata.tokenId)
                    $(".score").text(response.properties.risk)
                    switch(response.properties.risk){
                        case "low":
                            $(".score").addClass("green")
                            break;
                        case "med":
                            $(".score").addClass("orange")
                            break;
                        case "high":
                            $(".score").addClass("red")
                            break;
                    }
                    $(".vault_image").attr('src', response.liveMetadata.media.length > 0? response.liveMetadata.media[0].raw: !response.metadata.image.includes("ipfs")? `response.metadata.image`: `https://gateway.ipfs.io/ipfs/${response.metadata.image_ipfs}`)
                    $('.vault_name').html(response.assetName)
                    $('.vault_description').html(response.description)
                    $('.vault_address').html(response.vaultBtcAddress)
                    response.properties.isOrdinal? $('.ordinal_owner').html(response.ordinalOwner): {}
                    displayProperties(response.properties)
                    response.balances.length >0 ? displayBalances(response.balances): $(".balances").html("Empty Vault")
                    response.properties.reasons.length > 0? displayReasons(response.properties.reasons): {}
                },
                onFailure: function(response) {
                    $(".error.message").html(`error: ${response.message}`)
                    $(".error").addClass('visible')
                    $(".error").removeClass('hidden')
                }
            })

            function getVaults(start){
                $(".modal_content").text("")
                fetch(`https://api2.emblemvault.io:443/ordinal/all/?start=${start}&size=10&live=true`)
                    .then(response => response.json())
                    .then(result => {     
                        $(".modal_header").text(`(${start} - ${start + 10} of ${result.total}) Recent Ordinal Vaults`)
                        result.records.forEach(record=>{
                            $(".modal_content").append(`<a href="/?start=${start}&url=https://emblem.finance/nft?id=${record.tokenId}">${record.name}</a> | `)
                        })
                        $(".modal_content").append(`<a class="getMore"> Next Set</a>`)
                        $(".modal_content").prepend(`<a class="getLess"> Previous Set</a> | `)
                        $('.getMore').click(()=>{
                            getVaults(start+10)
                        })
                        $('.getLess').click(()=>{
                            getVaults(start> 10? start-10: 0)
                        })
                        
                    })
            }

            function displayProperties(properties) {
                $(".properties").html("")
                Object.keys(properties).forEach(item=>{
                    item != "inscriptionLink" && item != "reasons"?  $(".properties").append(createPropertyItem(item, properties[item])): {}
                })
            }
            function displayBalances(balances) {
                $(".balances").html("")
                balances.forEach((balance, index)=>{
                    Object.keys(balance).forEach(item=>{
                        $(".balances").append(createPropertyItem(item, balances[index][item]))
                    })
                })
            }
            function displayReasons(reasons) {
                $(".reasons").html("")
                reasons.forEach((reason, index)=>{
                   $(".reasons").append(createReasonItem(reason))                    
                })
            }
            function createPropertyItem(name, value) {
                return `<div class="prop ui blue image label">
                            ${name}
                            <div class="detail">
                                ${value}
                            </div>
                        </div>`
            }
            function createReasonItem(reason) {
                let color =  reason[0] == "+" ? "green" : "red"
                return `<div class="prop ui ${color} image label">
                            ${reason}
                        </div>`
            }
            function getParameterByName(name, url = window.location.href) {
                name = name.replace(/[\[\]]/g, '\\$&');
                var regex = new RegExp('[?&]' + name + '(=([^&#]*)|&|#|$)'),
                    results = regex.exec(url);
                if (!results) return null;
                if (!results[2]) return '';
                return decodeURIComponent(results[2].replace(/\+/g, ' '));
            }
    </script>
</body>

</html>